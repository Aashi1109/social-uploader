Project: Social Uploader (Express + BullMQ + Sequelize)

## Project Overview

Social Uploader is a backend service designed to publish media (videos/images) to multiple social media platforms (Instagram, YouTube) via a unified API. It handles media normalization, upload, and publishing asynchronously using a queue-based architecture.

## How it Works

1. **Request**: Client sends `POST /v1/publish` with media URL and target platforms.
2. **Validation**: API validates payload and checks idempotency (deduplication).
3. **Ingestion**: A job is enqueued in the `master` queue. API returns a `requestId`.
4. **Orchestration**: The Master Worker picks up the job and creates separate jobs for each target platform in the `publish` queue (e.g., `publish-instagram`, `publish-youtube`).
5. **Execution**: Platform Workers process these jobs. They may trigger a `media-prep` job if the media needs normalization (e.g., format conversion).
6. **Tracing**: Throughout the process, workers emit canonical events (e.g., `upload.started`, `publish.done`). A Trace Writer listens to these events and updates the `traces`, `stages`, and `steps` tables in the database, providing a real-time timeline of the publishing process.

## High-level contracts

- **API**: Express TypeScript. `POST /v1/publish` (Bearer auth, ajv validation, idempotent), `GET /v1/publish/:id` (timeline view). Rate limit: 30 req/min on POST.
- **Queues**: BullMQ with ioredis. Queues: `master`, `publish`, `media-prep`. Use `QueueEvents` when awaiting job completion.
- **Workers**: Dynamic loader in `src/core/loader.ts`. `WORKER_NAME` filters by substring.
- **Events & Trace**: Emit canonical events for timeline. Trace writer persists events and updates DB. Must tolerate out-of-order arrivals.
- **Secrets**: Local AES-256-GCM with `MASTER_KEY` (64 hex). Never log decrypted data. Use `SecretsService` (`src/features/secrets/service.ts`).
- **Logging & Metrics**: Pino + pino-http; JSON logs. Prometheus metrics at `/metrics`.
- **Database**: Postgres via Sequelize. Redis for queues.

## TypeScript & Style

- **Strict TypeScript**: No implicit any. Prefer explicit types.
- **Path Aliases** (MUST use):
  - `@api/*` → `src/api/*`
  - `@core/*` → `src/core/*`
  - `@workers/*` → `src/workers/*`
  - `@shared/*` → `src/shared/*`
  - `@features/*` → `src/features/*`
- **Structure**: Keep edits minimal and focused. Preserve existing style.
- **Naming**: Functions are verbs, variables are nouns. Avoid abbreviations.

## Sequelize & Database

- **ORM**: Sequelize with TypeScript decorators.
- **Models**: Located in `src/features/*/model.ts`.
- **Table Mapping**: Use `tableName` and `underscored: true`.
- **Core Tables**: `projects`, `platforms`, `secrets`, `traces`, `stages`, `steps`, `events`.
- **Config**: Prefer DB-backed config (load projects + platforms).

## API Contracts

- **POST /v1/publish**:
  - Auth: `Authorization: Bearer <token>`
  - Body: `{ projectId, mediaUrl, idempotencyKey?, title?, description?, platforms? }`
  - Returns: `{ requestId }`
- **GET /v1/publish/:id**:
  - Returns trace, stages (with steps), events.

## Queues & Workers

- **Master Queue**: Orchestrates platform jobs.
- **Publish Queue**: One job per platform. Emits `platform.started` → `prep.*` → `upload.*` → `publish.*` → `platform.finished`.
- **Media-Prep Queue**: Normalizes media. Emits `prep.started` / `prep.done`.

## Event Model (Canonical)

- **Names**: `publish.request.received`, `publish.request.validated`, `publish.request.queued`, `platform.started`, `prep.started`, `prep.done`, `prep.failed`, `upload.started`, `upload.done`, `upload.failed`, `publish.started`, `publish.done`, `publish.failed`, `platform.finished`, `publish.completed`.

## Secrets

- Only use `SecretsService`. Encrypt with AES-256-GCM.
- Scopes: `global` → fallback; `project:{id}` → preferred.

## Do/Don’t Checklist

- **Do** keep path aliases.
- **Do** validate inputs with ajv.
- **Do** keep idempotency behavior.
- **Do not** add Postgres/Redis services back into `docker-compose.yml`.
- **Do not** emit logs with raw secrets.
- **Do not** turn off TypeScript strictness.

## Quality Gates

- Lint/typecheck passes with zero errors.
- `POST /v1/publish` returns `{ requestId }`.
