// Prisma schema for social-uploader MVP

generator client {
    provider   = "prisma-client-js"
    output     = "./generated"
    engineType = "client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum PlatformName {
    instagram
    youtube
}

enum TraceStatus {
    running
    success
    partial
    failed
}

enum StageKind {
    master
    platform
}

enum StageStatus {
    running
    completed
    failed
}

enum StepName {
    prep
    upload
    publish
}

enum StepStatus {
    running
    completed
    failed
    skipped
}

model Project {
    id         String   @id @default(uuid(7))
    slug       String   @unique
    name       String
    webhookUrl String?  @map("webhook_url")
    createdAt  DateTime @default(now()) @map("created_at")
    updatedAt  DateTime @updatedAt @map("updated_at")

    platforms Platform[]
    secrets   Secret[]

    @@index([slug])
    @@map("projects")
}

model Platform {
    id        String       @id @default(uuid(7))
    projectId String       @map("project_id")
    name      PlatformName
    enabled   Boolean      @default(true)
    config    Json? // Contains: mediaProfile, credsRef, mapping, limits, maxDurationSeconds, minAspectRatio, maxAspectRatio, maxFileSizeMB
    createdAt DateTime     @default(now()) @map("created_at")
    updatedAt DateTime     @updatedAt @map("updated_at")

    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@unique([projectId, name])
    @@index([projectId])
    @@map("project_platforms")
}

model Secret {
    id             String       @id @default(uuid(7))
    projectId      String?      @map("project_id") // nullable for global secrets
    type           PlatformName // instagram | youtube | custom
    version        Int          @default(1)
    data_encrypted String
    meta           Json?
    createdAt      DateTime     @default(now()) @map("created_at")
    tokens         String?      @map("tokens")

    project Project? @relation(fields: [projectId], references: [id])

    @@index([type])
    @@map("secrets")
}

model Trace {
    id              String       @id @default(uuid(7)) @map("trace_id")
    projectId       String       @map("project_id")
    idempotencyKey  String?      @map("idempotency_key")
    status          TraceStatus // running | success | partial | failed (current runtime status)
    finalStatus     TraceStatus? @map("final_status") // optional mirror of status for audit
    totalStages     Int          @default(0) @map("total_stages")
    completedStages Int          @default(0) @map("completed_stages")
    payload         Json?        @map("payload")
    createdAt       DateTime     @default(now()) @map("created_at")
    updatedAt       DateTime     @updatedAt @map("updated_at")
    endedAt         DateTime?    @map("ended_at")
    durationMs      Int?         @map("duration_ms")

    stages Stage[]
    steps  Step[]
    events Event[]

    @@unique([projectId, idempotencyKey])
    @@index([projectId])
    @@map("traces")
}

model Stage {
    id                String      @id @default(uuid(7)) @map("stage_id")
    traceId           String      @map("trace_id")
    parentStageId     String?     @map("parent_stage_id")
    kind              StageKind // master | platform
    name              String // master | instagram | youtube | ...
    status            StageStatus // running | completed | failed
    progressCompleted Int         @default(0) @map("progress_completed")
    progressTotal     Int         @default(0) @map("progress_total")
    attempt           Int         @default(0)
    attrs             Json?       @map("attrs")
    startedAt         DateTime    @default(now()) @map("started_at")
    endedAt           DateTime?   @map("ended_at")
    durationMs        Int?        @map("duration_ms")
    error             Json?
    // Back-compat fields
    platform          String? // optional
    order             Int         @default(0)

    trace    Trace   @relation(fields: [traceId], references: [id], onDelete: Cascade)
    parent   Stage?  @relation("StageToStage", fields: [parentStageId], references: [id])
    children Stage[] @relation("StageToStage")
    steps    Step[]
    events   Event[]

    @@index([traceId])
    @@map("stages")
}

model Step {
    id         String     @id @default(uuid(7)) @map("step_id")
    traceId    String     @map("trace_id")
    stageId    String     @map("stage_id")
    name       StepName // prep | upload | publish
    status     StepStatus // running | completed | failed | skipped
    startedAt  DateTime   @default(now()) @map("started_at")
    endedAt    DateTime?  @map("ended_at")
    durationMs Int?       @map("duration_ms")
    meta       Json?
    error      Json?
    createdAt  DateTime   @default(now()) @map("created_at")
    updatedAt  DateTime   @updatedAt @map("updated_at")

    stage  Stage   @relation(fields: [stageId], references: [id], onDelete: Cascade)
    trace  Trace   @relation(fields: [traceId], references: [id], onDelete: Cascade)
    events Event[]

    @@index([stageId])
    @@index([traceId])
    @@map("steps")
}

model Event {
    id         String   @id @default(uuid(7)) @map("event_id")
    traceId    String   @map("trace_id")
    stageId    String?  @map("stage_id")
    stepId     String?  @map("step_id")
    timestamp  DateTime @default(now())
    name       String
    level      String?
    data       Json?
    // Back-compat fields used by code today
    platform   String?
    step       String?
    status     String?
    durationMs Int?
    meta       Json?
    createdAt  DateTime @default(now()) @map("created_at")

    trace   Trace  @relation(fields: [traceId], references: [id], onDelete: Cascade)
    stage   Stage? @relation(fields: [stageId], references: [id])
    stepRel Step?  @relation(fields: [stepId], references: [id])

    @@index([traceId, timestamp])
    @@index([stageId, timestamp])
    @@index([name])
    @@map("events")
}
